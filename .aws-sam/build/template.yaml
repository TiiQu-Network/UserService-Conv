AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'user-service

  Sample SAM Template for user-service

  '
Globals:
  Function:
    Timeout: 20
    MemorySize: 512
    Runtime: java21
    Architectures:
    - x86_64
    Environment:
      Variables:
        COGNITO_POOL_APP_CLIENT_ID: AQICAHiBGrtl37x374a4/EDnxTDXbiR3CI7yTyDT5A3MKW+p1QGb3lF2DT2M6xFqaSfvjBreAAAAeTB3BgkqhkiG9w0BBwagajBoAgEAMGMGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMOYL253xNWq/cGMQmAgEQgDYcNAQ3tWC5TAy9Hs65Lq4Yn2+jACZlgGAAKJXQqp7H4h20vLFS3XAsSnavhiBfbpgBfG8lU8w=
        COGNITO_POOL_APP_CLIENT_SECRET: AQICAHiBGrtl37x374a4/EDnxTDXbiR3CI7yTyDT5A3MKW+p1QEXr5UctUCk4SWsLmee24v3AAAAlTCBkgYJKoZIhvcNAQcGoIGEMIGBAgEAMHwGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMHfsoWZi7Rv6soO5lAgEQgE//IYyFkzNto/NiuuYQGuEHLZ0jLNd8zpUK7519UN1Bx7TcPTH/dHt+eKOx2lL5bWTehVUSh/fCZodIW4hGaYsawmSkPrbLq+ubqb4yDi4U
        COGNITO_USER_POOL_ID: AQICAHiBGrtl37x374a4/EDnxTDXbiR3CI7yTyDT5A3MKW+p1QG8mTSaJUul5h5tXAhrnejqAAAAcjBwBgkqhkiG9w0BBwagYzBhAgEAMFwGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMXpnC0vL5Pn044rFSAgEQgC91GoNd9dNSe4+doFBYq3h/WnMMF8RCOnzsyAf7CHBMj2IQmf1YqEOizyP9WJmXGg==
        COGNITO_USER_POOL_ADMIN_GROUP: Admins
        COGNITO_USER_POOL_USER_GROUP: Users
    Tracing: Active
    LoggingConfig:
      LogFormat: JSON
Resources:
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: user-service-pool-lib
      UsernameAttributes:
      - email
      AutoVerifiedAttributes:
      - email
      Schema:
      - Name: email
        Required: true
        Mutable: true
      - Name: firstName
        AttributeDataType: String
        Mutable: true
      - Name: lastName
        AttributeDataType: String
        Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: user-service-pool-lib-client
      UserPoolId:
        Ref: UserPool
      ExplicitAuthFlows:
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
      - ALLOW_CUSTOM_AUTH
      GenerateSecret: true
      SupportedIdentityProviders:
      - COGNITO
      CallbackURLs:
      - https://example.com/callback
      LogoutURLs:
      - https://example.com/logout
      AllowedOAuthFlows:
      - code
      AllowedOAuthScopes:
      - openid
      - email
      - profile
      - aws.cognito.signin.user.admin
  UserServiceLibApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: UserServiceLibApi
      StageName: Prod
      TracingEnabled: true
      Cors:
        AllowMethods: '''POST, GET'''
        AllowHeaders: '''X-Forwarded-For,Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent,AccessToken'''
        AllowOrigin: '''*'''
        MaxAge: '''600'''
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn:
              Fn::GetAtt:
              - UserPool
              - Arn
  SignupUserLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SignupUserLibHandlerFunction
      Handler: com.qutii.users.SignupUserHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:AdminAddUserToGroup
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        CreateUser:
          Type: Api
          Properties:
            Path: /users/signup
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: SignupUserLibHandlerFunction
  ConfirmUserLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ConfirmUserLibHandlerFunction
      Handler: com.qutii.users.ConfirmUserHandler::handleRequest
      Events:
        ConfirmUser:
          Type: Api
          Properties:
            Path: /users/confirm
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: ConfirmUserLibHandlerFunction
  LoginUserLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LoginUserLibHandlerFunction
      Handler: com.qutii.users.LoginUserHandler::handleRequest
      Events:
        LoginUser:
          Type: Api
          Properties:
            Path: /users/login
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: LoginUserLibHandlerFunction
  AddUserToGroupLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AddUserToGroupLibHandlerFunction
      Handler: com.qutii.users.AddUserToGroupHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:AdminAddUserToGroup
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        AddUserToGroup:
          Type: Api
          Properties:
            Path: /users/add-to-group
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: AddUserToGroupLibHandlerFunction
  RemoveUserFromGroupLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RemoveUserFromGroupLibHandlerFunction
      Handler: com.qutii.users.RemoveUserFromGroupHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:AdminRemoveUserFromGroup
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        RemoveUserFromGroup:
          Type: Api
          Properties:
            Path: /users/remove-from-group
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: RemoveUserFromGroupLibHandlerFunction
  GetUserLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetUserLibHandlerFunction
      Handler: com.qutii.users.GetUserHandler::handleRequest
      Events:
        GetUser:
          Type: Api
          Properties:
            Path: /users/me
            Method: get
            RestApiId:
              Ref: UserServiceLibApi
            RequestParameters:
            - method.request.header.AccessToken:
                Required: true
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: GetUserLibHandlerFunction
  UpdateUserLibHandlerHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UpdateUserLibHandlerHandlerFunction
      Handler: com.qutii.users.UpdateUserHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:AdminUpdateUserAttributes
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        RemoveUserFromGroup:
          Type: Api
          Properties:
            Path: /users/me
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            RequestParameters:
            - method.request.header.AccessToken:
                Required: true
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: UpdateUserLibHandlerHandlerFunction
  DeleteUserLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DeleteUserLibHandlerFunction
      Handler: com.qutii.users.DeleteUserHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:AdminDeleteUser
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        DeleteUser:
          Type: Api
          Properties:
            Path: /users/me/delete
            Method: get
            RestApiId:
              Ref: UserServiceLibApi
            RequestParameters:
            - method.request.header.AccessToken:
                Required: true
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: DeleteUserLibHandlerFunction
  SendVerificationCodeLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SendVerificationCodeLibHandlerFunction
      Handler: com.qutii.users.SendVerificationCodeHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:ResendConfirmationCode
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        ReSendVerificationCode:
          Type: Api
          Properties:
            Path: /users/send-verification-code
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: SendVerificationCodeLibHandlerFunction
  ForgotPasswordLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ForgotPasswordLibHandlerFunction
      Handler: com.qutii.users.ForgotPasswordHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:ForgotPassword
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        ForgotPassword:
          Type: Api
          Properties:
            Path: /users/forgot-password
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: ForgotPasswordLibHandlerFunction
  ConfirmForgotPasswordLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ConfirmForgotPasswordLibHandlerFunction
      Handler: com.qutii.users.ConfirmForgotPasswordHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:ConfirmForgotPassword
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        ConfirmForgotPassword:
          Type: Api
          Properties:
            Path: /users/confirm-forgot-password
            Method: post
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: NONE
    Metadata:
      SamResourceId: ConfirmForgotPasswordLibHandlerFunction
  GetUsersLibHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetUsersLibHandlerFunction
      Handler: com.qutii.users.GetUsersHandler::handleRequest
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - cognito-idp:ListUsers
          Resource: arn:aws:cognito-idp:eu-west-2:109607957842:userpool/eu-west-2_1JTzhVi38
      Events:
        GetUsers:
          Type: Api
          Properties:
            Path: /users/list
            Method: get
            RestApiId:
              Ref: UserServiceLibApi
            Auth:
              Authorizer: CognitoAuthorizer
    Metadata:
      SamResourceId: GetUsersLibHandlerFunction
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: true
Outputs:
  UserServiceLibApi:
    Description: API Gateway endpoint URL for Prod stage for User Service function
    Value:
      Fn::Sub: https://${UserServiceLibApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/users
  SignupUserLibHandlerFunction:
    Description: Signup Users Lambda Function ARN
    Value:
      Fn::GetAtt:
      - SignupUserLibHandlerFunction
      - Arn
  SignupUserLibHandlerFunctionIamRole:
    Description: Implicit IAM Role created for Signup function
    Value:
      Fn::GetAtt:
      - SignupUserLibHandlerFunctionRole
      - Arn
  ConfirmUserLibHandlerFunction:
    Description: Confirm User Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ConfirmUserLibHandlerFunction
      - Arn
  LoginUserLibHandlerFunction:
    Description: Login User Lambda Function ARN
    Value:
      Fn::GetAtt:
      - LoginUserLibHandlerFunction
      - Arn
  AddUserToGroupLibHandlerFunction:
    Description: Add User to Group Lambda Function ARN
    Value:
      Fn::GetAtt:
      - AddUserToGroupLibHandlerFunction
      - Arn
  RemoveUserFromGroupLibHandlerFunction:
    Description: Remove User from Group Lambda Function ARN
    Value:
      Fn::GetAtt:
      - RemoveUserFromGroupLibHandlerFunction
      - Arn
  GetUserLibHandlerFunction:
    Description: Get User Lambda Function ARN
    Value:
      Fn::GetAtt:
      - GetUserLibHandlerFunction
      - Arn
  GetUsersLibHandlerFunction:
    Description: Get Users Lambda Function ARN
    Value:
      Fn::GetAtt:
      - GetUsersLibHandlerFunction
      - Arn
  UpdateUserLibHandlerHandlerFunction:
    Description: Update User Lambda Function ARN
    Value:
      Fn::GetAtt:
      - UpdateUserLibHandlerHandlerFunction
      - Arn
  DeleteUserLibHandlerFunction:
    Description: Delete User Lambda Function ARN
    Value:
      Fn::GetAtt:
      - DeleteUserLibHandlerFunction
      - Arn
  SendVerificationCodeLibHandlerFunction:
    Description: Resend Verification Code Lambda Function ARN
    Value:
      Fn::GetAtt:
      - SendVerificationCodeLibHandlerFunction
      - Arn
  ForgotPasswordLibHandlerFunction:
    Description: Forgot Password Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ForgotPasswordLibHandlerFunction
      - Arn
  ConfirmForgotPasswordLibHandlerFunction:
    Description: Confirm Forgot Password Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ConfirmForgotPasswordLibHandlerFunction
      - Arn
  UserPoolId:
    Description: User Pool ID
    Value:
      Ref: UserPool
  UserPoolClientId:
    Description: User Pool Client ID
    Value:
      Ref: UserPoolClient
